
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>11.1. OpenMP Memory Model &#8212; OpenMP Application Programming Interface Examples</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="11.2. Memory Allocators" href="2_Memory_Allocators.html" />
    <link rel="prev" title="11. Memory Model" href="0_Chap_memory_model.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">OpenMP Application Programming Interface Examples</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Welcome to OMP Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Title_Page.html">
   Cover
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Foreword_Chapt.html">
   Foreword
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_introduction/0_Chap_introduction.html">
   1. Introduction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_introduction/1_Examples_Organization.html">
     1.1. Examples Organization
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_directives/0_Chap_directives.html">
   2. OpenMP Directive Syntax
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_directives/1_C_C%2B%2B_Pragmas.html">
     2.1. C/C++ Pragmas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_directives/2_C%2B%2B_Attributes.html">
     2.2. C++ Attributes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_directives/3_Fortran_Comments_Fixed_Source_Form.html">
     2.3. Fortran Comments (Fixed Source Form)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_directives/4_Fortran_Comments_Free_Source_Form.html">
     2.4. Fortran Comments (Free Source Form)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_parallel_execution/0_Chap_parallel_execution.html">
   3. Parallel Execution
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/1_A_Simple_Parallel_Loop.html">
     3.1. A Simple Parallel Loop
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/2_parallel_Construct.html">
     3.2.
     <strong>
      parallel
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/3_teams_Construct_on_Host.html">
     3.3.
     <strong>
      teams
     </strong>
     Construct on Host
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/4_Controlling_the_Number_of_Threads_on_Multiple_Nesting_Levels.html">
     3.4. Controlling the Number of Threads on Multiple Nesting Levels
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/5_Interaction_Between_the_num_threads_Clause_and_omp_set_dynamic.html">
     3.5. Interaction Between the
     <strong>
      num_threads
     </strong>
     Clause and
     <strong>
      omp_set_dynamic
     </strong>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/6_Fortran_Restrictions_on_the_do_Construct.html">
     3.6. Fortran Restrictions on the
     <strong>
      do
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/7_nowait_Clause.html">
     3.7.
     <strong>
      nowait
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/8_collapse_Clause.html">
     3.8.
     <strong>
      collapse
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/9_linear_Clause_in_Loop_Constructs.html">
     3.9.
     <strong>
      linear
     </strong>
     Clause in Loop Constructs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/10_parallel_sections_Construct.html">
     3.10.
     <strong>
      parallel
     </strong>
     <strong>
      sections
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/11_firstprivate_Clause_and_sections_Construct.html">
     3.11.
     <strong>
      firstprivate
     </strong>
     Clause and
     <strong>
      sections
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/12_single_Construct.html">
     3.12.
     <strong>
      single
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/13_workshare_Construct.html">
     3.13.
     <strong>
      workshare
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/14_masked_Construct.html">
     3.14.
     <strong>
      masked
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/15_loop_Construct.html">
     3.15.
     <strong>
      loop
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/16_Parallel_Random_Access_Iterator_Loop.html">
     3.16. Parallel Random Access Iterator Loop
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/17_omp_set_dynamic_and_omp_set_num_threads_Routines.html">
     3.17.
     <strong>
      omp_set_dynamic
     </strong>
     and
     <strong>
      omp_set_num_threads
     </strong>
     Routines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_parallel_execution/18_omp_get_num_threads_Routine.html">
     3.18.
     <strong>
      omp_get_num_threads
     </strong>
     Routine
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_affinity/0_Chap_affinity.html">
   4. OpenMP Affinity
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_affinity/1_proc_bind_Clause.html">
     4.1.
     <strong>
      proc_bind
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_affinity/2_Task_Affinity.html">
     4.2. Task Affinity
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_affinity/3_Affinity_Display.html">
     4.3. Affinity Display
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_affinity/4_Affinity_Query_Func.html">
     4.4. Affinity Query Functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_tasking/0_Chap_tasking.html">
   5. Tasking
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_tasking/1_task_and_taskwait_Constructs.html">
     5.1.
     <strong>
      task
     </strong>
     and
     <strong>
      taskwait
     </strong>
     Constructs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_tasking/2_Task_Priority.html">
     5.2. Task Priority
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_tasking/3_Task_Dependences.html">
     5.3. Task Dependences
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_tasking/4_Task_Detachment.html">
     5.4. Task Detachment
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_tasking/5_taskgroup_Construct.html">
     5.5.
     <strong>
      taskgroup
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_tasking/6_taskyield_Construct.html">
     5.6.
     <strong>
      taskyield
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_tasking/7_taskloop_Construct.html">
     5.7.
     <strong>
      taskloop
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_tasking/8_Combined_parallel_masked_and_taskloop_Constructs.html">
     5.8. Combined
     <strong>
      parallel
     </strong>
     <strong>
      masked
     </strong>
     and
     <strong>
      taskloop
     </strong>
     Constructs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_devices/0_Chap_devices.html">
   6. Devices
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/1_target_Construct.html">
     6.1.
     <strong>
      target
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/2_defaultmap_Clause.html">
     6.2.
     <strong>
      defaultmap
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/3_Pointer_Mapping.html">
     6.3. Pointer Mapping
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/4_Structure_Mapping.html">
     6.4. Structure Mapping
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/5_Fortran_Allocatable_Array_Mapping.html">
     6.5. Fortran Allocatable Array Mapping
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/6_Array_Sections_in_Device_Constructs.html">
     6.6. Array Sections in Device Constructs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/7_C%2B%2B_Virtual_Functions.html">
     6.7. C++ Virtual Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/8_Array_Shaping.html">
     6.8. Array Shaping
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/9_declare_mapper_Directive.html">
     6.9.
     <strong>
      declare mapper
     </strong>
     Directive
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/10_target_data_Construct.html">
     6.10.
     <strong>
      target
     </strong>
     <strong>
      data
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/11_target_enter_data_and_target_exit_data_Constructs.html">
     6.11.
     <strong>
      target
     </strong>
     <strong>
      enter
     </strong>
     <strong>
      data
     </strong>
     and
     <strong>
      target
     </strong>
     <strong>
      exit
     </strong>
     <strong>
      data
     </strong>
     Constructs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/12_target_update_Construct.html">
     6.12.
     <strong>
      target
     </strong>
     <strong>
      update
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/13_Declare_Target_Directive.html">
     6.13. Declare Target Directive
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/14_Lambda_Expressions.html">
     6.14. Lambda Expressions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/15_teams_Construct_and_Related_Combined_Constructs.html">
     6.15.
     <strong>
      teams
     </strong>
     Construct and Related Combined Constructs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/16_Asynchronous_target_Execution_and_Dependences.html">
     6.16. Asynchronous
     <strong>
      target
     </strong>
     Execution and Dependences
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_devices/17_Device_Routines.html">
     6.17. Device Routines
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_SIMD/0_Chap_SIMD.html">
   7. SIMD
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_SIMD/1_simd_and_declare_simd_Directives.html">
     7.1.
     <strong>
      simd
     </strong>
     and
     <strong>
      declare
     </strong>
     <strong>
      simd
     </strong>
     Directives
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_SIMD/2_inbranch_and_notinbranch_Clauses.html">
     7.2.
     <strong>
      inbranch
     </strong>
     and
     <strong>
      notinbranch
     </strong>
     Clauses
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_SIMD/3_Loop-Carried_Lexical_Forward_Dependence.html">
     7.3. Loop-Carried Lexical Forward Dependence
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_SIMD/4_ref_val_uvalModifiers_for_linear_Clause.html">
     7.4.
     <strong>
      ref
     </strong>
     ,
     <strong>
      val
     </strong>
     ,
     <strong>
      uval
     </strong>
     Modifiers for
     <strong>
      linear
     </strong>
     Clause
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_loop_transformations/0_Chap_loop_transformations.html">
   8. Loop Transformations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_loop_transformations/1_tile_Construct.html">
     8.1.
     <strong>
      tile
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_loop_transformations/2_unroll_Construct.html">
     8.2.
     <strong>
      unroll
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_loop_transformations/3_Incomplete_Tiles.html">
     8.3. Incomplete Tiles
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_synchronization/0_Chap_synchronization.html">
   9. Synchronization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/1_critical_Construct.html">
     9.1.
     <strong>
      critical
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/2_Worksharing_Constructs_Inside_a_critical_Construct.html">
     9.2. Worksharing Constructs Inside a
     <strong>
      critical
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/3_Binding_of_barrier_Regions.html">
     9.3. Binding of
     <strong>
      barrier
     </strong>
     Regions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/4_atomic_Construct.html">
     9.4.
     <strong>
      atomic
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/5_Restrictions_on_the_atomic_Construct.html">
     9.5. Restrictions on the
     <strong>
      atomic
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/6_flush_Construct_without_a_List.html">
     9.6.
     <strong>
      flush
     </strong>
     Construct without a List
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/7_Synchronization_Based_on_Acquire_Release_Semantics.html">
     9.7. Synchronization Based on Acquire/Release Semantics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/8_ordered_Clause_and_ordered_Construct.html">
     9.8.
     <strong>
      ordered
     </strong>
     Clause and
     <strong>
      ordered
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/9_depobj_Construct.html">
     9.9.
     <strong>
      depobj
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/10_Doacross_Loop_Nest.html">
     9.10. Doacross Loop Nest
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_synchronization/11_Lock_Routines.html">
     9.11. Lock Routines
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_data_environment/0_Chap_data_environment.html">
   10. Data Environment
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/1_threadprivate_Directive.html">
     10.1.
     <strong>
      threadprivate
     </strong>
     Directive
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/2_default_none_Clause.html">
     10.2.
     <strong>
      default(none)
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/3_private_Clause.html">
     10.3.
     <strong>
      private
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/4_Fortran_Private_Loop_Iteration_Variables.html">
     10.4. Fortran Private Loop Iteration Variables
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/5_Fortran_Restrictions_on_shared_and_private_Clauses_with_Common_Blocks.html">
     10.5. Fortran Restrictions on
     <strong>
      shared
     </strong>
     and
     <strong>
      private
     </strong>
     Clauses with Common Blocks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/6_Fortran_Restrictions_on_Storage_Association_with_the_private_Clause.html">
     10.6. Fortran Restrictions on Storage Association with the
     <strong>
      private
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/7_C_C%2B%2B_Arrays_in_a_firstprivate_Clause.html">
     10.7. C/C++ Arrays in a
     <strong>
      firstprivate
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/8_lastprivate_Clause.html">
     10.8.
     <strong>
      lastprivate
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/9_Reduction.html">
     10.9. Reduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/10_scan_Directive.html">
     10.10.
     <strong>
      scan
     </strong>
     Directive
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/11_copyin_Clause.html">
     10.11.
     <strong>
      copyin
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/12_copyprivate_Clause.html">
     10.12.
     <strong>
      copyprivate
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/13_C%2B%2B_Reference_in_Data-Sharing_Clauses.html">
     10.13. C++ Reference in Data-Sharing Clauses
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_data_environment/14_Fortran_ASSOCIATE_Construct.html">
     10.14. Fortran
     <strong>
      ASSOCIATE
     </strong>
     Construct
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="0_Chap_memory_model.html">
   11. Memory Model
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     11.1. OpenMP Memory Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_Memory_Allocators.html">
     11.2. Memory Allocators
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="3_Race_Conditions_Caused_by_Implied_Copies_of_Shared_Variables_in_Fortran.html">
     11.3. Race Conditions Caused by Implied Copies of Shared Variables in Fortran
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_program_control/0_Chap_program_control.html">
   12. Program Control
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/1_Conditional_Compilation.html">
     12.1. Conditional Compilation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/2_Internal_Control_Variables_ICVs.html">
     12.2. Internal Control Variables (ICVs)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/3_Placement_of_flush%2C_barrier_taskwait_and_taskyield_Directives.html">
     12.3. Placement of
     <strong>
      flush
     </strong>
     ,
     <strong>
      barrier
     </strong>
     ,
     <strong>
      taskwait
     </strong>
     and
     <strong>
      taskyield
     </strong>
     Directives
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/4_Cancellation_Constructs.html">
     12.4. Cancellation Constructs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/5_requires_Directive.html">
     12.5.
     <strong>
      requires
     </strong>
     Directive
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/6_declare_variant_Directive.html">
     12.6.
     <strong>
      declare
     </strong>
     <strong>
      variant
     </strong>
     Directive
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/7_Metadirectives.html">
     12.7. Metadirectives
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/8_Nested_Loop_Constructs.html">
     12.8. Nested Loop Constructs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/9_Restrictions_on_Nesting_of_Regions.html">
     12.9. Restrictions on Nesting of Regions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/10_Target_Offload.html">
     12.10. Target Offload
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/11_Controlling_Concurrency_and_Reproducibility_with_the_order_Clause.html">
     12.11. Controlling Concurrency and Reproducibility with  the
     <strong>
      order
     </strong>
     Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/12_interop_Construct.html">
     12.12.
     <strong>
      interop
     </strong>
     Construct
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_program_control/13_Utilities.html">
     12.13. Utilities
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_ompt_interface/0_Chap_ompt_interface.html">
   13. OMPT Interface
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_ompt_interface/1_OMPT_Start.html">
     13.1. OMPT Start
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/passlab/Examples/main?urlpath=lab/tree/notebook/contents/Chap_memory_model/1_OpenMP_Memory_Model.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/passlab/Examples"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/passlab/Examples/issues/new?title=Issue%20on%20page%20%2Fcontents/Chap_memory_model/1_OpenMP_Memory_Model.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/contents/Chap_memory_model/1_OpenMP_Memory_Model.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>OpenMP Memory Model</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="openmp-memory-model">
<h1><span class="section-number">11.1. </span>OpenMP Memory Model<a class="headerlink" href="#openmp-memory-model" title="Permalink to this headline">#</a></h1>
<p>The following examples illustrate two major concerns for concurrent thread execution: ordering of thread execution and memory accesses that may or may not lead to race conditions.</p>
<p>In the following example, at Print 1, the value of <strong>xval</strong> could be either 2 or 5, depending on the timing of the threads. The <strong>atomic</strong> directives are necessary for the accesses to <strong>x</strong> by threads 1 and 2 to avoid a data race. If the atomic write completes before the atomic read, thread 1 is guaranteed to see 5 in <strong>xval</strong>. Otherwise, thread 1 is guaranteed to see 2 in <strong>xval</strong>.</p>
<p><em>flushes!implicit</em> <em>atomic construct <strong>atomic</strong> construct</em> <em>constructs!atomic <strong>atomic</strong></em> The barrier after Print 1 contains implicit flushes on all threads, as well as a thread synchronization, so the programmer is guaranteed that the value 5 will be printed by both Print 2 and Print 3. Since neither Print 2 or Print 3 are modifying <strong>x</strong>, they may concurrently access <strong>x</strong> without requiring <strong>atomic</strong> directives to avoid a data race.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: mem_model.1</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_3.1</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cp">#pragma omp parallel num_threads(2) shared(x)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="cp">#pragma omp atomic write</span>
<span class="w">       </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">xval</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp atomic read</span>
<span class="w">      </span><span class="n">xval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Print 1: xval can be 2 or 5 */</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;1: Thread# %d: x = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">(),</span><span class="w"> </span><span class="n">xval</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">#pragma omp barrier</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Print 2 */</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;2: Thread# %d: x = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">(),</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Print 3 */</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;3: Thread# %d: x = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">(),</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">mem_model</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_3</span><span class="mf">.1</span><span class="w"></span>
<span class="n">PROGRAM</span><span class="w"> </span><span class="n">MEMMODEL</span><span class="w"></span>
<span class="w">  </span><span class="n">INCLUDE</span><span class="w"> </span><span class="s">&quot;omp_lib.h&quot;</span><span class="w">      </span><span class="o">!</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">OMP_LIB</span><span class="w"></span>
<span class="w">  </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">XVAL</span><span class="w"></span>

<span class="w">  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">NUM_THREADS</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">SHARED</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">IF</span><span class="w"> </span><span class="p">(</span><span class="n">OMP_GET_THREAD_NUM</span><span class="p">()</span><span class="w"> </span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">THEN</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">ATOMIC</span><span class="w"> </span><span class="n">WRITE</span><span class="w"></span>
<span class="w">       </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="n">ELSE</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">ATOMIC</span><span class="w"> </span><span class="n">READ</span><span class="w"></span>
<span class="w">      </span><span class="n">XVAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="w"> </span><span class="n">PRINT</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">XVAL</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">      </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="s">&quot;1: THREAD# &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">OMP_GET_THREAD_NUM</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;X = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">XVAL</span><span class="w"></span>
<span class="w">    </span><span class="n">ENDIF</span><span class="w"></span>

<span class="w"> </span><span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">BARRIER</span><span class="w"></span>

<span class="w">    </span><span class="n">IF</span><span class="w"> </span><span class="p">(</span><span class="n">OMP_GET_THREAD_NUM</span><span class="p">()</span><span class="w"> </span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">THEN</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="w"> </span><span class="n">PRINT</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">      </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="s">&quot;2: THREAD# &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">OMP_GET_THREAD_NUM</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;X = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="w"></span>
<span class="w">    </span><span class="n">ELSE</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="w"> </span><span class="n">PRINT</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">      </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="s">&quot;3: THREAD# &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">OMP_GET_THREAD_NUM</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;X = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="w"></span>
<span class="w">    </span><span class="n">ENDIF</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>

<span class="n">END</span><span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">MEMMODEL</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example demonstrates why synchronization is difficult to perform correctly through variables. The write to <strong>flag</strong> on thread 0 and the read from <strong>flag</strong> in the loop on thread 1 must be atomic to avoid a data race. When thread 1 breaks out of the loop, <strong>flag</strong> will have the value of 1. However, <strong>data</strong> will still be undefined at the first print statement. Only after the flush of both <strong>flag</strong> and <strong>data</strong> after the first print statement will <strong>data</strong> have the well-defined value of 42.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: mem_model.2</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_3.1</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#pragma omp parallel num_threads(2)</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* Write to the data buffer that will be</span>
<span class="cm">       * read by thread */</span><span class="w"></span>
<span class="w">          </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* Flush data to thread 1 and strictly order</span>
<span class="cm">       * the write to data relative to the write to the flag */</span><span class="w"></span>
<span class="w">          </span><span class="cp">#pragma omp flush(flag, data)</span>
<span class="w">      </span><span class="cm">/* Set flag to release thread 1 */</span><span class="w"></span>
<span class="w">          </span><span class="cp">#pragma omp atomic write</span>
<span class="w">          </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* Loop until we see the update to the flag */</span><span class="w"></span>
<span class="w">          </span><span class="cp">#pragma omp flush(flag, data)</span>
<span class="w">          </span><span class="kt">int</span><span class="w"> </span><span class="n">flag_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">flag_val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">             </span><span class="cp">#pragma omp atomic read</span>
<span class="w">             </span><span class="n">flag_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* Value of flag is 1; value of data is undefined */</span><span class="w"></span>
<span class="w">          </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;flag=%d data=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="cp">#pragma omp flush(flag, data)</span>
<span class="w">      </span><span class="cm">/* Value of flag is 1; value of data is 42 */</span><span class="w"></span>
<span class="w">          </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;flag=%d data=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>!!%compiler: gfortran
!!%cflags: -fopenmp

! name: mem_model.2
! type: F-fixed
! version: omp_3.1
       PROGRAM EXAMPLE
       INCLUDE &quot;omp_lib.h&quot; ! or USE OMP_LIB
       INTEGER DATA
       INTEGER FLAG, FLAG_VAL

       FLAG = 0
!$OMP  PARALLEL NUM_THREADS(2)
         IF(OMP_GET_THREAD_NUM() .EQ. 0) THEN
         ! Write to the data buffer that will be read by thread 1
            DATA = 42

         ! Flush DATA to thread 1 and strictly order the write to DATA
         ! relative to the write to the FLAG
!$OMP       FLUSH(FLAG, DATA)

         ! Set FLAG to release thread 1
!$OMP       ATOMIC WRITE
            FLAG = 1

         ELSE IF(OMP_GET_THREAD_NUM() .EQ. 1) THEN
         ! Loop until we see the update to the FLAG
!$OMP       FLUSH(FLAG, DATA)
            FLAG_VAL = 0
            DO WHILE(FLAG_VAL .LT. 1)
!$OMP          ATOMIC READ
               FLAG_VAL = FLAG
            ENDDO

         ! Value of FLAG is 1; value of DATA is undefined
            PRINT *, &#39;FLAG=&#39;, FLAG, &#39; DATA=&#39;, DATA

!$OMP       FLUSH(FLAG, DATA)
         ! Value of FLAG is 1; value of DATA is 42
            PRINT *, &#39;FLAG=&#39;, FLAG, &#39; DATA=&#39;, DATA

         ENDIF
!$OMP  END PARALLEL
       END
</pre></div>
</div>
</div>
</div>
<p>The next example demonstrates why synchronization is difficult to perform correctly through variables. As in the preceding example, the updates to <strong>flag</strong> and the reading of <strong>flag</strong> in the loops on threads 1 and 2 are performed atomically to avoid data races on <strong>flag</strong>. However, the code still contains data race due to the incorrect use of “flush with a list’’ after the assignment to <strong>data1</strong> on thread 1. By not including <strong>flag</strong> in the flush-set of that <strong>flush</strong> directive, the assignment can be reordered with respect to the subsequent atomic update to <strong>flag</strong>. Consequentially, <strong>data1</strong> is undefined at the print statement on thread 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: mem_model.3</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_3.1</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">data0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="cp">#pragma omp parallel num_threads(3)</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">data0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">17</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="cp">#pragma omp flush</span>
<span class="w">         </span><span class="cm">/* Set flag to release thread 1 */</span><span class="w"></span>
<span class="w">         </span><span class="cp">#pragma omp atomic update</span>
<span class="w">         </span><span class="n">flag</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="cm">/* Flush of flag is implied by the atomic directive */</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">flag_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="cm">/* Loop until we see that flag reaches 1*/</span><span class="w"></span>
<span class="w">         </span><span class="k">while</span><span class="p">(</span><span class="n">flag_val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cp">#pragma omp atomic read</span>
<span class="w">            </span><span class="n">flag_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="w">         </span><span class="cp">#pragma omp flush(data0)</span>
<span class="w">         </span><span class="cm">/* data0 is 17 here */</span><span class="w"></span>
<span class="w">         </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread 1 awoken (data0 = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data0</span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="n">data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="cp">#pragma omp flush(data1)</span>
<span class="w">         </span><span class="cm">/* Set flag to release thread 2 */</span><span class="w"></span>
<span class="w">         </span><span class="cp">#pragma omp atomic update</span>
<span class="w">         </span><span class="n">flag</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="cm">/* Flush of flag is implied by the atomic directive */</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">flag_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="cm">/* Loop until we see that flag reaches 2 */</span><span class="w"></span>
<span class="w">         </span><span class="k">while</span><span class="p">(</span><span class="n">flag_val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cp">#pragma omp atomic read</span>
<span class="w">            </span><span class="n">flag_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="w">         </span><span class="cp">#pragma omp flush(data0,data1)</span>
<span class="w">         </span><span class="cm">/* there is a data race here;</span>
<span class="cm">            data0 is 17 and data1 is undefined */</span><span class="w"></span>
<span class="w">         </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread 2 awoken (data0 = %d, data1 = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">data0</span><span class="p">,</span><span class="w"> </span><span class="n">data1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>!!%compiler: gfortran
!!%cflags: -fopenmp

! name: mem_model.3
! type: F-fixed
! version: omp_3.1
       PROGRAM EXAMPLE
       INCLUDE &quot;omp_lib.h&quot; ! or USE OMP_LIB
       INTEGER FLAG, FLAG_VAL
       INTEGER DATA0, DATA1

       FLAG = 0
!$OMP  PARALLEL NUM_THREADS(3)
         IF(OMP_GET_THREAD_NUM() .EQ. 0) THEN
             DATA0 = 17
!$OMP        FLUSH

         ! Set flag to release thread 1
!$OMP        ATOMIC UPDATE
             FLAG = FLAG + 1
         ! Flush of FLAG is implied by the atomic directive

         ELSE IF(OMP_GET_THREAD_NUM() .EQ. 1) THEN
         ! Loop until we see that FLAG reaches 1
!$OMP        FLUSH(FLAG, DATA)
             FLAG_VAL = 0
             DO WHILE(FLAG_VAL .LT. 1)
!$OMP           ATOMIC READ
                FLAG_VAL = FLAG
             ENDDO
!$OMP        FLUSH

         ! DATA0 is 17 here
             PRINT *, &#39;Thread 1 awoken. DATA0 = &#39;, DATA0

             DATA1 = 42
!$OMP        FLUSH(DATA1)

         ! Set FLAG to release thread 2
!$OMP        ATOMIC UPDATE
             FLAG = FLAG + 1
         ! Flush of FLAG is implied by the atomic directive

         ELSE IF(OMP_GET_THREAD_NUM() .EQ. 2) THEN
         ! Loop until we see that FLAG reaches 2
             FLAG_VAL = 0
             DO WHILE(FLAG_VAL .LT. 2)
!$OMP           ATOMIC READ
                FLAG_VAL = FLAG
             ENDDO
!$OMP        FLUSH(DATA0, DATA1)

         ! There is a data race here; data0 is 17 and data1 is undefined
             PRINT *, &#39;Thread 2 awoken. DATA0 = &#39;, DATA0,
     &amp;                &#39; and DATA1 = &#39;, DATA1

         ENDIF
!$OMP  END PARALLEL
       END
</pre></div>
</div>
</div>
</div>
<p>The following two examples illustrate the ordering properties of  the  <em>flush</em>  operation. The  <em>flush</em>  operations are strong flushes  that are applied to the specified flush lists.  However, use of a <strong>flush</strong> construct with a list is extremely error  prone and users are strongly discouraged from attempting it.  In the codes the programmer intends to prevent simultaneous  execution of the protected section by the two threads. The atomic directives in the codes ensure that the accesses to shared variables  <em>a</em>  and  <em>b</em>  are atomic write and atomic read operations. Otherwise both examples would contain data races and automatically result  in unspecified behavior.</p>
<p>In the following incorrect code example, operations on variables  <em>a</em>  and  <em>b</em>  are not ordered with respect to each other. For instance, nothing prevents the compiler from moving the flush of  <em>b</em>  on thread 0 or the flush of  <em>a</em>  on thread 1 to a position completely after the protected section (assuming that the protected section on thread 0 does not reference  <em>b</em>  and the protected section on thread 1 does not reference  <em>a</em> ). If either re-ordering happens, both threads can simultaneously execute the protected section. Any shared data accessed in the protected section is not guaranteed to  be current or consistent during or after the protected section.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: mem_model.4a</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_3.1</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">flush_incorrect</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cp">#pragma omp parallel num_threads(2)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">myid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">        </span><span class="c1">// thread 0</span>
<span class="w">      </span><span class="cp">#pragma omp atomic write</span>
<span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp flush(b)    </span><span class="c1">// flushes are not ordered</span>
<span class="w">      </span><span class="cp">#pragma omp flush(a)    </span><span class="c1">// compiler may move them around</span>
<span class="w">      </span><span class="cp">#pragma omp atomic read</span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">                    </span><span class="c1">// thread 1</span>
<span class="w">      </span><span class="cp">#pragma omp atomic write</span>
<span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp flush(a)    </span><span class="c1">// flushes are not ordered</span>
<span class="w">      </span><span class="cp">#pragma omp flush(b)    </span><span class="c1">// compiler may move them around</span>
<span class="w">      </span><span class="cp">#pragma omp atomic read</span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">         </span><span class="c1">// exclusive access not guaranteed</span>
<span class="w">      </span><span class="cm">/* protected section */</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">mem_model</span><span class="mf">.4</span><span class="n">a</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_3</span><span class="mf">.1</span><span class="w"></span>
<span class="n">subroutine</span><span class="w"> </span><span class="n">flush_incorrect</span><span class="w"></span>
<span class="w">  </span><span class="n">use</span><span class="w"> </span><span class="n">omp_lib</span><span class="w"></span>
<span class="w">  </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="n">myid</span><span class="w"></span>

<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">private</span><span class="p">(</span><span class="n">myid</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="n">num_threads</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">myid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">then</span><span class="w">     </span><span class="o">!</span><span class="w"> </span><span class="kr">thread</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">atomic</span><span class="w"> </span><span class="n">write</span><span class="w"></span>
<span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">flush</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="n">flushes</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">ordered</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">flush</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="n">around</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">atomic</span><span class="w"> </span><span class="n">read</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w">                      </span><span class="o">!</span><span class="w"> </span><span class="kr">thread</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">atomic</span><span class="w"> </span><span class="n">write</span><span class="w"></span>
<span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">flush</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="n">flushes</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">ordered</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">flush</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="n">around</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">atomic</span><span class="w"> </span><span class="n">read</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="w">    </span><span class="n">endif</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">then</span><span class="w">      </span><span class="o">!</span><span class="w"> </span><span class="n">exclusive</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">guaranteed</span><span class="w"></span>
<span class="w">      </span><span class="o">!!</span><span class="w"> </span><span class="n">protected</span><span class="w"> </span><span class="n">section</span><span class="w"></span>
<span class="w">    </span><span class="n">endif</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following code example correctly ensures that the protected section is executed by only one thread at a time. Execution of the protected section by neither thread is considered correct in this example. This occurs if both flushes complete prior to either thread executing its <strong>if</strong> statement for the protected section. The compiler is prohibited from moving the flush at all for either thread, ensuring that the respective assignment is complete and the data is flushed before the <strong>if</strong> statement is executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: mem_model.4b</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_3.1</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">flush_correct</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cp">#pragma omp parallel num_threads(2)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">myid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">          </span><span class="c1">// thread 0</span>
<span class="w">      </span><span class="cp">#pragma omp atomic write</span>
<span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp flush(a,b)    </span><span class="c1">// flushes are ordered</span>
<span class="w">      </span><span class="cp">#pragma omp atomic read</span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">                      </span><span class="c1">// thread 1</span>
<span class="w">      </span><span class="cp">#pragma omp atomic write</span>
<span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp flush(a,b)    </span><span class="c1">// flushes are ordered</span>
<span class="w">      </span><span class="cp">#pragma omp atomic read</span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">           </span><span class="c1">// access by single thread</span>
<span class="w">      </span><span class="cm">/* protected section */</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">mem_model</span><span class="mf">.4</span><span class="n">b</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_3</span><span class="mf">.1</span><span class="w"></span>
<span class="n">subroutine</span><span class="w"> </span><span class="n">flush_correct</span><span class="w"></span>
<span class="w">  </span><span class="n">use</span><span class="w"> </span><span class="n">omp_lib</span><span class="w"></span>
<span class="w">  </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="n">myid</span><span class="w"></span>

<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">private</span><span class="p">(</span><span class="n">myid</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="n">num_threads</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">myid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">then</span><span class="w">     </span><span class="o">!</span><span class="w"> </span><span class="kr">thread</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">atomic</span><span class="w"> </span><span class="n">write</span><span class="w"></span>
<span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">flush</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">flushes</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">ordered</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">atomic</span><span class="w"> </span><span class="n">read</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w">                      </span><span class="o">!</span><span class="w"> </span><span class="kr">thread</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">atomic</span><span class="w"> </span><span class="n">write</span><span class="w"></span>
<span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">flush</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">flushes</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">ordered</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">atomic</span><span class="w"> </span><span class="n">read</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="w">    </span><span class="n">endif</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">then</span><span class="w">      </span><span class="o">!</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="kr">thread</span><span class="w"></span>
<span class="w">      </span><span class="o">!!</span><span class="w"> </span><span class="n">protected</span><span class="w"> </span><span class="n">section</span><span class="w"></span>
<span class="w">    </span><span class="n">endif</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "native"
        },
        kernelOptions: {
            kernelName: "native",
            path: "./contents/Chap_memory_model"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'native'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="0_Chap_memory_model.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">11. </span>Memory Model</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="2_Memory_Allocators.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">11.2. </span>Memory Allocators</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The OpenMP Community<br/>
  
      &copy; <a href="../../copyright.html">Copyright</a> 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>